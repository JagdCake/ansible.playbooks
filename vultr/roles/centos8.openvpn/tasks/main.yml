---
- name: install OpenVPN
  yum:
    name: openvpn
    state: installed

# makes sure there is no timezone mismatch when the client
# checks the timestamp on the certificate generated by the server
# prevents certificate's not working
- name: align the server timezone with the client timezone
  timezone:
    name: "{{ my_timezone }}"

# download EasyRSA
# utility used to generate and sign PKI certificates used by OpenVPN
- name: download EasyRSA
  get_url:
    url: https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.6/EasyRSA-unix-v3.0.6.tgz
    dest: /etc/openvpn/easyrsa.tgz
  register: download

- name: install tar
  yum:
    name: tar
    state: installed

- name: unarchive EasyRSA
  unarchive:
    remote_src: yes
    src: "{{ download.dest }}"
    dest: /etc/openvpn
    # makes the list of unarchived files accessible to the registered variable
    list_files: yes
  register: easyrsa

- name: delete the EasyRSA archive
  file:
    path: "{{ download.dest }}"
    state: absent

# needed for setting up a certificate authority
- name: initialize public key infrastructure
  command: ./easyrsa init-pki
  args:
    # cd into the directory created after unarchiving
    # the first file in the list is the root EasyRSA directory
    chdir: "/etc/openvpn/{{ easyrsa.files[0] }}"
    creates: "/etc/openvpn/{{ easyrsa.files[0] }}/pki/"

# needed for the "expect" module to work
- name: install pexpect
  yum:
    name: python3-pexpect
    state: installed

# prevents error when creating certificate authority
# Source: https://security.stackexchange.com/a/177512/166908
- name: generate OpenSSL randfile
  command: dd if=/dev/urandom of=pki/.rnd bs=256 count=1
  args:
    chdir: "/etc/openvpn/{{ easyrsa.files[0] }}"
    creates: "/etc/openvpn/{{ easyrsa.files[0] }}/pki/.rnd"

- name: create certificate authority
  expect:
    command: ./easyrsa build-ca
    responses:
      .*Enter.*\sPassphrase:\s$: "{{ ca_key_passphrase }}"
      .*Re-Enter.*\sPassphrase:\s$: "{{ ca_key_passphrase }}"
      .*Common\sName.*: "{{ username }}"
  args:
    chdir: "/etc/openvpn/{{ easyrsa.files[0] }}"
    creates: "/etc/openvpn/{{ easyrsa.files[0] }}/pki/ca.crt"

- name: transport client's certificate request
  copy:
    src: "/home/{{ username }}/Documents/{{ easyrsa.files[0] }}/pki/reqs/{{ client_entity_name }}.req"
    dest: "/tmp/{{ client_entity_name }}.req"
  register: cert_req

- name: import client's certificate request
  command: ./easyrsa import-req "{{ cert_req.dest }}" "{{ client_entity_name }}"
  args:
    chdir: "/etc/openvpn/{{ easyrsa.files[0] }}"
    creates: "/etc/openvpn/{{ easyrsa.files[0] }}/pki/reqs/{{ client_entity_name }}.req"

- name: sign client's certificate request
  expect:
    command: ./easyrsa sign-req client "{{ client_entity_name }}"
    responses:
      .*Confirm.*:\s$: "yes"
      # note that some of the prompts don't end with whitespace
      # could be changed in a future version
      .*Enter.*ca.key:$: "{{ ca_key_passphrase }}"
  args:
    chdir: "/etc/openvpn/{{ easyrsa.files[0] }}"
    creates: "/etc/openvpn/{{ easyrsa.files[0] }}/pki/issued/{{ client_entity_name }}.crt"

- name: transfer signed certificate to client
  fetch:
    src: "/etc/openvpn/{{ easyrsa.files[0] }}/pki/issued/{{ client_entity_name }}.crt"
    # destination dir must end with a "/"
    # so that the file is fetched into it
    dest: "{{ openvpn_client_dir }}/"
    flat: yes

- name: transfer CA certificate to client
  fetch:
    src: "/etc/openvpn/{{ easyrsa.files[0] }}/pki/ca.crt"
    dest: "{{ openvpn_client_dir }}/"
    flat: yes
...
